plugins {
    id 'java'
    id 'jacoco'
    id 'org.springframework.boot' version '4.0.1'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'com.github.node-gradle.node' version '7.1.0'
}

group = 'pl.klastbit'
version = '0.0.1-SNAPSHOT'
description = 'lexpage'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

repositories {
    mavenCentral()
    maven {
        url 'https://projectlombok.org/edge-releases'
    }
    maven {
        url 'https://repo.spring.io/snapshot'
    }
    maven {
        url 'https://repo.spring.io/milestone'
    }
}

// Node.js configuration
node {
    version = '20.11.0'  // LTS version
    npmVersion = '10.2.4'
    download = true  // Automatycznie pobierze Node.js
    nodeProjectDir = file("${project.projectDir}")
}

tasks.withType(JavaCompile).configureEach {
    options.fork = true
    options.forkOptions.jvmArgs += [
        '--add-opens=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.jvm=ALL-UNNAMED'
    ]
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-liquibase'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-webmvc'
    implementation 'org.springframework.boot:spring-boot-starter-json'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    runtimeOnly 'org.postgresql:postgresql'

    // Spring Boot DevTools dla hot-reload
    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    // Lombok - using edge build for Java 25 support
    compileOnly 'org.projectlombok:lombok:edge-SNAPSHOT'
    annotationProcessor 'org.projectlombok:lombok:edge-SNAPSHOT'
    testCompileOnly 'org.projectlombok:lombok:edge-SNAPSHOT'
    testAnnotationProcessor 'org.projectlombok:lombok:edge-SNAPSHOT'

    // Spring AI for OpenRouter integration
    // Using 2.0.0-M2 compatible with Spring Boot 4.0
    implementation platform('org.springframework.ai:spring-ai-bom:2.0.0-M2')
    implementation 'org.springframework.ai:spring-ai-openai'

    // CommonMark for Markdown to HTML conversion
    implementation 'org.commonmark:commonmark:0.27.1'

    testImplementation 'org.springframework.boot:spring-boot-starter-data-jpa-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-liquibase-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-thymeleaf-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // TestContainers for integration tests
    testImplementation platform('org.testcontainers:testcontainers-bom:1.20.4')
    testImplementation 'org.springframework.boot:spring-boot-testcontainers'
    testImplementation 'org.testcontainers:postgresql'
    testImplementation 'org.testcontainers:junit-jupiter'
}

tasks.named('test') {
    useJUnitPlatform()

    // Kontynuuj wykonywanie wszystkich testów nawet jeśli niektóre się nie powiodą
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }

    // Wyłącz failFast - wszystkie testy będą wykonane niezależnie od niepowodzeń
    systemProperty 'junit.jupiter.execution.failfast.enabled', 'false'

    // Report is always generated after tests run
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test // tests are required to run before generating the report

    reports {
        xml.required = true
        html.required = true
    }
}

// Task: Build frontend for production (minified CSS)
tasks.register('buildFrontend', com.github.gradle.node.npm.task.NpmTask) {
    description = 'Builds frontend assets (Tailwind CSS minified)'
    dependsOn 'npmInstall'
    args = ['run', 'build']
}

// Task: Run Tailwind in watch mode (development)
tasks.register('tailwindWatch', com.github.gradle.node.npm.task.NpmTask) {
    description = 'Runs Tailwind CSS in watch mode for development'
    dependsOn 'npmInstall'
    args = ['run', 'dev']
}

// Task: Clean frontend build artifacts
tasks.register('cleanFrontend', com.github.gradle.node.npm.task.NpmTask) {
    description = 'Cleans frontend build artifacts'
    args = ['run', 'clean']
}

// Integrate frontend build with Gradle build lifecycle
processResources {
    dependsOn 'buildFrontend'
}

clean {
    dependsOn 'cleanFrontend'
}

bootRun {
    dependsOn 'npmInstall'
}

// Development task: Run Spring Boot with Tailwind watch
tasks.register('devRun') {
    description = 'Runs application in development mode with Tailwind watch'
    group = 'application'

    doFirst {
        println "Starting development environment..."
        println "- Spring Boot will run on port 8080"
        println "- Tailwind CSS will watch for changes"
        println "- LiveReload enabled on port 35729"
        println ""
        println "NOTE: Tailwind watch must be run separately in another terminal:"
        println "  ./gradlew tailwindWatch"
        println ""
    }
}
