<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/admin :: layout(~{::content})}">
<head>
    <title th:text="${pageTitle}">Zarządzanie Blogami</title>
</head>
<body>
<div th:fragment="content">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Zarządzanie Artykułami</h1>
                <p class="mt-2 text-gray-600">Przeglądaj, edytuj i zarządzaj artykułami blogowymi</p>
            </div>
            <a href="/admin/blogs/new"
               class="inline-flex items-center justify-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors shadow-md hover:shadow-lg whitespace-nowrap"
               data-ripple-light="true">
                <i class="material-icons mr-2 text-xl">add</i>
                Dodaj Nowy Artykuł
            </a>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Status Filter -->
            <div>
                <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
                    Status
                </label>
                <select id="statusFilter"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Wszystkie</option>
                    <option value="DRAFT">Draft</option>
                    <option value="PUBLISHED">Published</option>
                    <option value="ARCHIVED">Archived</option>
                </select>
            </div>

            <!-- Search Input -->
            <div>
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">
                    Wyszukiwanie
                </label>
                <input type="text"
                       id="searchInput"
                       placeholder="Szukaj po tytule..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-xl shadow-md p-8 text-center hidden">
        <div class="flex flex-col items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mb-4"></div>
            <p class="text-gray-600">Ładowanie artykułów...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="bg-white rounded-xl shadow-md p-8 text-center hidden">
        <div class="flex flex-col items-center justify-center py-12">
            <i class="material-icons text-6xl text-red-600 mb-4">error_outline</i>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Wystąpił błąd</h3>
            <p id="errorMessage" class="text-gray-600 mb-4"></p>
            <button onclick="loadArticles()"
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                    data-ripple-light="true">
                Spróbuj ponownie
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-white rounded-xl shadow-md p-8 text-center hidden">
        <div class="flex flex-col items-center justify-center py-12">
            <i class="material-icons text-6xl text-gray-400 mb-4">article</i>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Brak artykułów</h3>
            <p class="text-gray-600 mb-4">Nie znaleziono żadnych artykułów spełniających kryteria wyszukiwania.</p>
            <a href="/admin/blogs/new"
               class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors inline-block"
               data-ripple-light="true">
                Dodaj pierwszy artykuł
            </a>
        </div>
    </div>

    <!-- Articles Table -->
    <div id="articlesTable" class="bg-white rounded-xl shadow-md overflow-hidden hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tytuł
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Data utworzenia
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Data aktualizacji
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Akcje
                    </th>
                </tr>
                </thead>
                <tbody id="articlesTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Rendered by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="mt-6 hidden">
        <!-- Rendered by JavaScript -->
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="material-icons text-red-600">warning</i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Usuń artykuł</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Czy na pewno chcesz usunąć ten artykuł? Ta operacja jest nieodwracalna.
                    </p>
                </div>
                <div class="flex gap-4 px-4 py-3">
                    <button onclick="closeDeleteModal()"
                            class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg hover:bg-gray-300 transition-colors"
                            data-ripple-light="true">
                        Anuluj
                    </button>
                    <button onclick="confirmDelete()"
                            class="flex-1 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-lg hover:bg-red-700 transition-colors"
                            data-ripple-light="true">
                        Usuń
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        // State
        let currentPage = 0;
        let currentStatus = '';
        let currentKeyword = '';
        let articleToDelete = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadArticles();

            // Event listeners
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentStatus = this.value;
                currentPage = 0;
                loadArticles();
            });

            // Debounced search
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentKeyword = this.value;
                    currentPage = 0;
                    loadArticles();
                }, 500);
            });
        });

        // Load articles from API
        async function loadArticles() {
            showState('loading');

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    size: 20,
                    sort: 'createdAt,desc'
                });

                if (currentStatus) {
                    params.append('status', currentStatus);
                }

                if (currentKeyword) {
                    params.append('keyword', currentKeyword);
                }

                const response = await fetch(`/api/articles?${params}`);

                if (!response.ok) {
                    throw new Error('Failed to load articles');
                }

                const data = await response.json();

                if (data.content && data.content.length > 0) {
                    renderArticles(data.content);
                    renderPagination(data.page);
                    showState('table');
                } else {
                    showState('empty');
                }
            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('errorMessage').textContent = error.message;
                showState('error');
            }
        }

        // Render articles table
        function renderArticles(articles) {
            const tbody = document.getElementById('articlesTableBody');
            tbody.innerHTML = '';

            articles.forEach(article => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Title and slug
                const titleCell = document.createElement('td');
                titleCell.className = 'px-6 py-4';
                titleCell.innerHTML = `
                    <div class="text-sm font-medium text-gray-900">${escapeHtml(article.title)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(article.slug)}</div>
                `;
                row.appendChild(titleCell);

                // Status badge
                const statusCell = document.createElement('td');
                statusCell.className = 'px-6 py-4 whitespace-nowrap';
                statusCell.innerHTML = renderStatusBadge(article.status);
                row.appendChild(statusCell);

                // Created at
                const createdCell = document.createElement('td');
                createdCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                createdCell.textContent = formatDate(article.createdAt);
                row.appendChild(createdCell);

                // Updated at
                const updatedCell = document.createElement('td');
                updatedCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                updatedCell.textContent = formatDate(article.updatedAt);
                row.appendChild(updatedCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                actionsCell.innerHTML = renderActions(article);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });
        }

        // Render status badge
        function renderStatusBadge(status) {
            const badges = {
                'DRAFT': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Draft</span>',
                'PUBLISHED': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Published</span>',
                'ARCHIVED': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Archived</span>'
            };
            return badges[status] || status;
        }

        // Render action buttons based on status
        function renderActions(article) {
            let actions = `
                <a href="/admin/blogs/${article.id}/edit"
                   class="text-primary-600 hover:text-primary-900 mr-3">
                    Edytuj
                </a>
            `;

            if (article.status === 'DRAFT') {
                actions += `
                    <button onclick="publishArticle(${article.id})"
                            class="text-green-600 hover:text-green-900 mr-3">
                        Publikuj
                    </button>
                `;
            } else if (article.status === 'PUBLISHED') {
                actions += `
                    <button onclick="archiveArticle(${article.id})"
                            class="text-yellow-600 hover:text-yellow-900 mr-3">
                        Archiwizuj
                    </button>
                    <button onclick="unpublishArticle(${article.id})"
                            class="text-gray-600 hover:text-gray-900 mr-3">
                        Cofnij publikację
                    </button>
                `;
            }

            actions += `
                <button onclick="openDeleteModal(${article.id})"
                        class="text-red-600 hover:text-red-900">
                    Usuń
                </button>
            `;

            return actions;
        }

        // Render pagination
        function renderPagination(pageInfo) {
            const container = document.getElementById('paginationContainer');

            if (pageInfo.totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            let html = '<div class="flex justify-center items-center space-x-2">';

            // Previous button
            if (pageInfo.number > 0) {
                html += `
                    <button onclick="changePage(${pageInfo.number - 1})"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                            data-ripple-light="true">
                        Poprzednia
                    </button>
                `;
            }

            // Page numbers
            for (let i = 0; i < pageInfo.totalPages; i++) {
                const isActive = i === pageInfo.number;
                html += `
                    <button onclick="changePage(${i})"
                            class="px-4 py-2 border rounded-lg transition-colors ${isActive ? 'bg-primary-600 text-white border-primary-600' : 'bg-white border-gray-300 hover:bg-gray-50'}"
                            data-ripple-light="true">
                        ${i + 1}
                    </button>
                `;
            }

            // Next button
            if (pageInfo.number < pageInfo.totalPages - 1) {
                html += `
                    <button onclick="changePage(${pageInfo.number + 1})"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                            data-ripple-light="true">
                        Następna
                    </button>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadArticles();
        }

        // Publish article
        async function publishArticle(id) {
            if (!confirm('Czy na pewno chcesz opublikować ten artykuł?')) {
                return;
            }

            try {
                const response = await fetch(`/api/articles/${id}/publish`, {
                    method: 'PATCH'
                });

                if (!response.ok) {
                    throw new Error('Failed to publish article');
                }

                loadArticles();
            } catch (error) {
                console.error('Error publishing article:', error);
                alert('Nie udało się opublikować artykułu: ' + error.message);
            }
        }

        // Archive article
        async function archiveArticle(id) {
            if (!confirm('Czy na pewno chcesz zarchiwizować ten artykuł?')) {
                return;
            }

            try {
                const response = await fetch(`/api/articles/${id}/archive`, {
                    method: 'PATCH'
                });

                if (!response.ok) {
                    throw new Error('Failed to archive article');
                }

                loadArticles();
            } catch (error) {
                console.error('Error archiving article:', error);
                alert('Nie udało się zarchiwizować artykułu: ' + error.message);
            }
        }

        // Unpublish article
        async function unpublishArticle(id) {
            if (!confirm('Czy na pewno chcesz cofnąć publikację tego artykułu?')) {
                return;
            }

            try {
                const response = await fetch(`/api/articles/${id}/unpublish`, {
                    method: 'PATCH'
                });

                if (!response.ok) {
                    throw new Error('Failed to unpublish article');
                }

                loadArticles();
            } catch (error) {
                console.error('Error unpublishing article:', error);
                alert('Nie udało się cofnąć publikacji artykułu: ' + error.message);
            }
        }

        // Delete modal functions
        function openDeleteModal(id) {
            articleToDelete = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            articleToDelete = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (!articleToDelete) return;

            try {
                const response = await fetch(`/api/articles/${articleToDelete}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete article');
                }

                closeDeleteModal();
                loadArticles();
            } catch (error) {
                console.error('Error deleting article:', error);
                alert('Nie udało się usunąć artykułu: ' + error.message);
            }
        }

        // Show/hide states
        function showState(state) {
            const states = ['loading', 'error', 'empty', 'table'];
            states.forEach(s => {
                const element = document.getElementById(s === 'table' ? 'articlesTable' : s + 'State');
                if (element) {
                    if (s === state) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });

            if (state !== 'table') {
                document.getElementById('paginationContainer').classList.add('hidden');
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</div>
</body>
</html>
