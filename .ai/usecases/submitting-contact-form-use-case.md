# Implementation Plan: Contact Form Use Case (US1)

## Overview
Implementation of the contact form submission use case from PRD (US1) following hexagonal architecture with DDD principles. This is a **simplified MVP version** that focuses on core functionality:
- Contact form submission with validation
- Database persistence
- Rate limiting (3 messages per hour per IP)
- **Deferred**: Email notifications and reCAPTCHA (to be added later)

## Architecture

  ```                                                                                                                                                                                                                                                                                                               
  ┌─────────────────────────────────────────────────────────────┐                                                                                                                                                                                                                                                   
  │                    Web Layer (Inbound)                      │                                                                                                                                                                                                                                                   
  │  ContactFormController → SubmitContactFormRequest DTO       │                                                                                                                                                                                                                                                   
  └─────────────────────┬───────────────────────────────────────┘                                                                                                                                                                                                                                                   
  │                                                                                                                                                                                                                                                                                                                 
  ┌─────────────────────▼───────────────────────────────────────┐                                                                                                                                                                                                                                                   
  │                  Application Layer                          │                                                                                                                                                                                                                                                   
  │  ContactFormApplicationService (orchestrator)               │                                                                                                                                                                                                                                                   
  │  SubmitContactFormCommand (Record)                         │                                                                                                                                                                                                                                                    
  │  ContactFormResult (Record)                                │                                                                                                                                                                                                                                                    
  └─────────────────────┬───────────────────────────────────────┘                                                                                                                                                                                                                                                   
  │                                                                                                                                                                                                                                                                                                                 
  ┌─────────────────────▼───────────────────────────────────────┐                                                                                                                                                                                                                                                   
  │                    Domain Layer                             │                                                                                                                                                                                                                                                   
  │  ContactMessage (Aggregate Root) ✓ EXISTS                  │                                                                                                                                                                                                                                                    
  │  ContactRepository (Port Interface) → TO CREATE             │                                                                                                                                                                                                                                                   
  │  Domain Exceptions → TO CREATE                              │                                                                                                                                                                                                                                                   
  └─────────────────────┬───────────────────────────────────────┘                                                                                                                                                                                                                                                   
  │                                                                                                                                                                                                                                                                                                                 
  ┌─────────────────────▼───────────────────────────────────────┐                                                                                                                                                                                                                                                   
  │              Infrastructure Layer (Outbound)                │                                                                                                                                                                                                                                                   
  │  ContactRepositoryAdapter (implements port)                 │                                                                                                                                                                                                                                                   
  │  JpaContactMessageRepository (Spring Data)                  │                                                                                                                                                                                                                                                   
  │  ContactMessageMapper ✓ EXISTS                             │                                                                                                                                                                                                                                                    
  └─────────────────────────────────────────────────────────────┘                                                                                                                                                                                                                                                   
  ```                                                                                                                                                                                                                                                                                                               

## Implementation Steps

### Phase 1: Domain Layer - Repository Port and Exceptions

#### File 1: Domain Repository Interface
**Path**: `src/main/java/pl/klastbit/lexpage/domain/contact/ContactRepository.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.domain.contact;                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import java.time.LocalDateTime;                                                                                                                                                                                                                                                                                   
  import java.util.Optional;                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Repository port interface for ContactMessage aggregate.                                                                                                                                                                                                                                                         
  * Part of domain layer - defines contract without implementation details.                                                                                                                                                                                                                                         
  */                                                                                                                                                                                                                                                                                                                
  public interface ContactRepository {                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Saves a new or existing contact message.                                                                                                                                                                                                                                                                        
  */                                                                                                                                                                                                                                                                                                                
  ContactMessage save(ContactMessage contactMessage);                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Finds contact message by ID.                                                                                                                                                                                                                                                                                    
  */                                                                                                                                                                                                                                                                                                                
  Optional<ContactMessage> findById(Long id);                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Counts messages from a specific IP address within a time range.                                                                                                                                                                                                                                                 
  * Used for rate limiting (max 3 messages per hour).                                                                                                                                                                                                                                                               
  */                                                                                                                                                                                                                                                                                                                
  int countByIpAddressAndCreatedAtAfter(String ipAddress, LocalDateTime since);                                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Port interface in domain layer following dependency inversion principle. Infrastructure will implement this.

#### File 2: Rate Limit Exception
**Path**: `src/main/java/pl/klastbit/lexpage/domain/contact/exception/RateLimitExceededException.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.domain.contact.exception;                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Domain exception thrown when rate limit is exceeded.                                                                                                                                                                                                                                                            
  */                                                                                                                                                                                                                                                                                                                
  public class RateLimitExceededException extends RuntimeException {                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  private final int maxAllowed;                                                                                                                                                                                                                                                                                     
  private final int periodInHours;                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                    
  public RateLimitExceededException(int maxAllowed, int periodInHours) {                                                                                                                                                                                                                                            
  super(String.format("Rate limit exceeded. Maximum %d messages allowed per %d hour(s)",                                                                                                                                                                                                                            
  maxAllowed, periodInHours));                                                                                                                                                                                                                                                                                      
  this.maxAllowed = maxAllowed;                                                                                                                                                                                                                                                                                     
  this.periodInHours = periodInHours;                                                                                                                                                                                                                                                                               
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  public int getMaxAllowed() {                                                                                                                                                                                                                                                                                      
  return maxAllowed;                                                                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  public int getPeriodInHours() {                                                                                                                                                                                                                                                                                   
  return periodInHours;                                                                                                                                                                                                                                                                                             
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Domain exception for rate limiting business rule. Keeps business logic in domain layer.
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

### Phase 2: Application Layer - Use Case Implementation

#### File 3: Submit Contact Form Command
**Path**: `src/main/java/pl/klastbit/lexpage/application/contact/command/SubmitContactFormCommand.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.application.contact.command;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                    
  import pl.klastbit.lexpage.domain.contact.MessageCategory;                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Command to submit a contact form.                                                                                                                                                                                                                                                                               
  * Java Record for immutability (follows DDD command pattern).                                                                                                                                                                                                                                                     
  */                                                                                                                                                                                                                                                                                                                
  public record SubmitContactFormCommand(                                                                                                                                                                                                                                                                           
  String firstName,                                                                                                                                                                                                                                                                                                 
  String lastName,                                                                                                                                                                                                                                                                                                  
  String email,                                                                                                                                                                                                                                                                                                     
  String phone,                                                                                                                                                                                                                                                                                                     
  MessageCategory category,                                                                                                                                                                                                                                                                                         
  String message,                                                                                                                                                                                                                                                                                                   
  String ipAddress,                                                                                                                                                                                                                                                                                                 
  String userAgent                                                                                                                                                                                                                                                                                                  
  ) {                                                                                                                                                                                                                                                                                                               
  public SubmitContactFormCommand {                                                                                                                                                                                                                                                                                 
  if (firstName == null || firstName.isBlank()) {                                                                                                                                                                                                                                                                   
  throw new IllegalArgumentException("First name is required");                                                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                                                                                 
  if (lastName == null || lastName.isBlank()) {                                                                                                                                                                                                                                                                     
  throw new IllegalArgumentException("Last name is required");                                                                                                                                                                                                                                                      
  }                                                                                                                                                                                                                                                                                                                 
  if (email == null || email.isBlank()) {                                                                                                                                                                                                                                                                           
  throw new IllegalArgumentException("Email is required");                                                                                                                                                                                                                                                          
  }                                                                                                                                                                                                                                                                                                                 
  if (category == null) {                                                                                                                                                                                                                                                                                           
  throw new IllegalArgumentException("Category is required");                                                                                                                                                                                                                                                       
  }                                                                                                                                                                                                                                                                                                                 
  if (message == null || message.isBlank()) {                                                                                                                                                                                                                                                                       
  throw new IllegalArgumentException("Message is required");                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Immutable command object with validation. Records are perfect for commands in DDD.

#### File 4: Contact Form Result
**Path**: `src/main/java/pl/klastbit/lexpage/application/contact/result/ContactFormResult.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.application.contact.result;                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Result of contact form submission.                                                                                                                                                                                                                                                                              
  */                                                                                                                                                                                                                                                                                                                
  public record ContactFormResult(                                                                                                                                                                                                                                                                                  
  Long messageId,                                                                                                                                                                                                                                                                                                   
  String fullName,                                                                                                                                                                                                                                                                                                  
  String email,                                                                                                                                                                                                                                                                                                     
  boolean success,                                                                                                                                                                                                                                                                                                  
  String message                                                                                                                                                                                                                                                                                                    
  ) {                                                                                                                                                                                                                                                                                                               
  public static ContactFormResult success(Long messageId, String fullName, String email) {                                                                                                                                                                                                                          
  return new ContactFormResult(                                                                                                                                                                                                                                                                                     
  messageId,                                                                                                                                                                                                                                                                                                        
  fullName,                                                                                                                                                                                                                                                                                                         
  email,                                                                                                                                                                                                                                                                                                            
  true,                                                                                                                                                                                                                                                                                                             
  "Dziękujemy! Odpowiemy w ciągu 24h."                                                                                                                                                                                                                                                                              
  );                                                                                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  public static ContactFormResult failure(String errorMessage) {                                                                                                                                                                                                                                                    
  return new ContactFormResult(null, null, null, false, errorMessage);                                                                                                                                                                                                                                              
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Type-safe result object. Uses factory methods for clean API.

#### File 5: Contact Form Application Service
**Path**: `src/main/java/pl/klastbit/lexpage/application/contact/service/ContactFormApplicationService.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.application.contact.service;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                    
  import lombok.RequiredArgsConstructor;                                                                                                                                                                                                                                                                            
  import lombok.extern.slf4j.Slf4j;                                                                                                                                                                                                                                                                                 
  import org.springframework.stereotype.Service;                                                                                                                                                                                                                                                                    
  import org.springframework.transaction.annotation.Transactional;                                                                                                                                                                                                                                                  
  import pl.klastbit.lexpage.application.contact.command.SubmitContactFormCommand;                                                                                                                                                                                                                                  
  import pl.klastbit.lexpage.application.contact.result.ContactFormResult;                                                                                                                                                                                                                                          
  import pl.klastbit.lexpage.domain.contact.ContactMessage;                                                                                                                                                                                                                                                         
  import pl.klastbit.lexpage.domain.contact.ContactRepository;                                                                                                                                                                                                                                                      
  import pl.klastbit.lexpage.domain.contact.exception.RateLimitExceededException;                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                    
  import java.math.BigDecimal;                                                                                                                                                                                                                                                                                      
  import java.time.LocalDateTime;                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Application service for contact form use case.                                                                                                                                                                                                                                                                  
  * Orchestrates domain logic, validation, and persistence.                                                                                                                                                                                                                                                         
  */                                                                                                                                                                                                                                                                                                                
  @Service                                                                                                                                                                                                                                                                                                          
  @RequiredArgsConstructor                                                                                                                                                                                                                                                                                          
  @Slf4j                                                                                                                                                                                                                                                                                                            
  public class ContactFormApplicationService {                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                    
  private final ContactRepository contactRepository;                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  private static final int MAX_MESSAGES_PER_HOUR = 3;                                                                                                                                                                                                                                                               
  private static final int RATE_LIMIT_HOURS = 1;                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Submits contact form with validation and rate limiting.                                                                                                                                                                                                                                                         
  */                                                                                                                                                                                                                                                                                                                
  @Transactional                                                                                                                                                                                                                                                                                                    
  public ContactFormResult submitContactForm(SubmitContactFormCommand command) {                                                                                                                                                                                                                                    
  log.info("Processing contact form submission from: {} {}",                                                                                                                                                                                                                                                        
  command.firstName(), command.lastName());                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                    
  try {                                                                                                                                                                                                                                                                                                             
  // 1. Check rate limit                                                                                                                                                                                                                                                                                            
  checkRateLimit(command.ipAddress());                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  // 2. Create domain entity (business validation happens here)                                                                                                                                                                                                                                                     
  // Note: Using default reCAPTCHA score 0.9 for MVP (no verification yet)                                                                                                                                                                                                                                          
  ContactMessage contactMessage = ContactMessage.create(                                                                                                                                                                                                                                                            
  command.firstName(),                                                                                                                                                                                                                                                                                              
  command.lastName(),                                                                                                                                                                                                                                                                                               
  command.email(),                                                                                                                                                                                                                                                                                                  
  command.phone(),                                                                                                                                                                                                                                                                                                  
  command.category(),                                                                                                                                                                                                                                                                                               
  command.message(),                                                                                                                                                                                                                                                                                                
  new BigDecimal("0.9"), // Default score for MVP                                                                                                                                                                                                                                                                   
  command.ipAddress(),                                                                                                                                                                                                                                                                                              
  command.userAgent()                                                                                                                                                                                                                                                                                               
  );                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  // 3. Persist to database                                                                                                                                                                                                                                                                                         
  ContactMessage savedMessage = contactRepository.save(contactMessage);                                                                                                                                                                                                                                             
  log.info("Contact message saved with ID: {}", savedMessage.getId());                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  // 4. TODO: Send email notification (deferred to future iteration)                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  return ContactFormResult.success(                                                                                                                                                                                                                                                                                 
  savedMessage.getId(),                                                                                                                                                                                                                                                                                             
  savedMessage.getFullName(),                                                                                                                                                                                                                                                                                       
  savedMessage.getEmail()                                                                                                                                                                                                                                                                                           
  );                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  } catch (RateLimitExceededException e) {                                                                                                                                                                                                                                                                          
  log.warn("Contact form submission rejected: {}", e.getMessage());                                                                                                                                                                                                                                                 
  throw e;                                                                                                                                                                                                                                                                                                          
  } catch (IllegalArgumentException e) {                                                                                                                                                                                                                                                                            
  log.warn("Invalid contact form data: {}", e.getMessage());                                                                                                                                                                                                                                                        
  return ContactFormResult.failure(e.getMessage());                                                                                                                                                                                                                                                                 
  } catch (Exception e) {                                                                                                                                                                                                                                                                                           
  log.error("Error processing contact form", e);                                                                                                                                                                                                                                                                    
  return ContactFormResult.failure("Wystąpił nieoczekiwany błąd");                                                                                                                                                                                                                                                  
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Checks if IP address has exceeded rate limit.                                                                                                                                                                                                                                                                   
  */                                                                                                                                                                                                                                                                                                                
  private void checkRateLimit(String ipAddress) {                                                                                                                                                                                                                                                                   
  if (ipAddress == null) {                                                                                                                                                                                                                                                                                          
  return; // Skip rate limiting if IP not available                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  LocalDateTime since = LocalDateTime.now().minusHours(RATE_LIMIT_HOURS);                                                                                                                                                                                                                                           
  int messageCount = contactRepository.countByIpAddressAndCreatedAtAfter(ipAddress, since);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                    
  if (messageCount >= MAX_MESSAGES_PER_HOUR) {                                                                                                                                                                                                                                                                      
  log.warn("Rate limit exceeded for IP: {}", ipAddress);                                                                                                                                                                                                                                                            
  throw new RateLimitExceededException(MAX_MESSAGES_PER_HOUR, RATE_LIMIT_HOURS);                                                                                                                                                                                                                                    
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Core orchestration logic. Handles rate limiting, domain object creation, and persistence. Uses @Transactional for atomicity.
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

### Phase 3: Infrastructure Layer - Persistence Adapter

#### File 6: Spring Data JPA Repository
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/adapters/persistence/repository/JpaContactMessageRepository.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.adapters.persistence.repository;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import org.springframework.data.jpa.repository.JpaRepository;                                                                                                                                                                                                                                                     
  import org.springframework.data.jpa.repository.Query;                                                                                                                                                                                                                                                             
  import org.springframework.data.repository.query.Param;                                                                                                                                                                                                                                                           
  import org.springframework.stereotype.Repository;                                                                                                                                                                                                                                                                 
  import pl.klastbit.lexpage.infrastructure.adapters.persistence.entity.ContactMessageEntity;                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import java.time.LocalDateTime;                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Spring Data JPA repository for ContactMessageEntity.                                                                                                                                                                                                                                                            
  * Infrastructure concern - not exposed to domain.                                                                                                                                                                                                                                                                 
  */                                                                                                                                                                                                                                                                                                                
  @Repository                                                                                                                                                                                                                                                                                                       
  public interface JpaContactMessageRepository extends JpaRepository<ContactMessageEntity, Long> {                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Counts messages from specific IP address after a given timestamp.                                                                                                                                                                                                                                               
  * Used for rate limiting.                                                                                                                                                                                                                                                                                         
  */                                                                                                                                                                                                                                                                                                                
  @Query("SELECT COUNT(c) FROM ContactMessageEntity c " +                                                                                                                                                                                                                                                           
  "WHERE c.ipAddress = :ipAddress " +                                                                                                                                                                                                                                                                               
  "AND c.createdAt > :since")                                                                                                                                                                                                                                                                                       
  int countByIpAddressAndCreatedAtAfter(                                                                                                                                                                                                                                                                            
  @Param("ipAddress") String ipAddress,                                                                                                                                                                                                                                                                             
  @Param("since") LocalDateTime since                                                                                                                                                                                                                                                                               
  );                                                                                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Spring Data JPA interface with custom query for rate limiting. Infrastructure layer detail.

#### File 7: Repository Adapter
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/adapters/persistence/repository/ContactRepositoryAdapter.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.adapters.persistence.repository;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import lombok.RequiredArgsConstructor;                                                                                                                                                                                                                                                                            
  import lombok.extern.slf4j.Slf4j;                                                                                                                                                                                                                                                                                 
  import org.springframework.stereotype.Component;                                                                                                                                                                                                                                                                  
  import pl.klastbit.lexpage.domain.contact.ContactMessage;                                                                                                                                                                                                                                                         
  import pl.klastbit.lexpage.domain.contact.ContactRepository;                                                                                                                                                                                                                                                      
  import pl.klastbit.lexpage.infrastructure.adapters.persistence.entity.ContactMessageEntity;                                                                                                                                                                                                                       
  import pl.klastbit.lexpage.infrastructure.adapters.persistence.mapper.ContactMessageMapper;                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import java.time.LocalDateTime;                                                                                                                                                                                                                                                                                   
  import java.util.Optional;                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Adapter implementation of ContactRepository port.                                                                                                                                                                                                                                                               
  * Bridges domain layer with JPA infrastructure.                                                                                                                                                                                                                                                                   
  */                                                                                                                                                                                                                                                                                                                
  @Component                                                                                                                                                                                                                                                                                                        
  @RequiredArgsConstructor                                                                                                                                                                                                                                                                                          
  @Slf4j                                                                                                                                                                                                                                                                                                            
  public class ContactRepositoryAdapter implements ContactRepository {                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  private final JpaContactMessageRepository jpaRepository;                                                                                                                                                                                                                                                          
  private final ContactMessageMapper mapper;                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  @Override                                                                                                                                                                                                                                                                                                         
  public ContactMessage save(ContactMessage contactMessage) {                                                                                                                                                                                                                                                       
  ContactMessageEntity entity = mapper.toEntity(contactMessage);                                                                                                                                                                                                                                                    
  ContactMessageEntity savedEntity = jpaRepository.save(entity);                                                                                                                                                                                                                                                    
  log.debug("Saved ContactMessageEntity with ID: {}", savedEntity.getId());                                                                                                                                                                                                                                         
  return mapper.toDomain(savedEntity);                                                                                                                                                                                                                                                                              
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  @Override                                                                                                                                                                                                                                                                                                         
  public Optional<ContactMessage> findById(Long id) {                                                                                                                                                                                                                                                               
  return jpaRepository.findById(id)                                                                                                                                                                                                                                                                                 
  .map(mapper::toDomain);                                                                                                                                                                                                                                                                                           
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  @Override                                                                                                                                                                                                                                                                                                         
  public int countByIpAddressAndCreatedAtAfter(String ipAddress, LocalDateTime since) {                                                                                                                                                                                                                             
  return jpaRepository.countByIpAddressAndCreatedAtAfter(ipAddress, since);                                                                                                                                                                                                                                         
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Implements domain port interface. Converts between domain and persistence models using mapper.

#### File 8: Mapper Configuration
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/config/MapperConfiguration.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.config;                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  import org.springframework.context.annotation.Bean;                                                                                                                                                                                                                                                               
  import org.springframework.context.annotation.Configuration;                                                                                                                                                                                                                                                      
  import pl.klastbit.lexpage.infrastructure.adapters.persistence.mapper.ContactMessageMapper;                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Configuration for mapper beans.                                                                                                                                                                                                                                                                                 
  * Mappers are stateless and can be shared as Spring beans.                                                                                                                                                                                                                                                        
  */                                                                                                                                                                                                                                                                                                                
  @Configuration                                                                                                                                                                                                                                                                                                    
  public class MapperConfiguration {                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  @Bean                                                                                                                                                                                                                                                                                                             
  public ContactMessageMapper contactMessageMapper() {                                                                                                                                                                                                                                                              
  return new ContactMessageMapper();                                                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Makes ContactMessageMapper available as Spring bean. Note: Remove @Component from ContactMessageMapper.java (line 4).
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

### Phase 4: Infrastructure Layer - Web Controller

#### File 9: Submit Contact Form Request DTO
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/web/dto/request/SubmitContactFormRequest.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.web.dto.request;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                    
  import jakarta.validation.constraints.*;                                                                                                                                                                                                                                                                          
  import pl.klastbit.lexpage.domain.contact.MessageCategory;                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Request DTO for contact form submission.                                                                                                                                                                                                                                                                        
  * Uses Bean Validation annotations for input validation.                                                                                                                                                                                                                                                          
  */                                                                                                                                                                                                                                                                                                                
  public record SubmitContactFormRequest(                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                    
  @NotBlank(message = "Imię jest wymagane")                                                                                                                                                                                                                                                                         
  @Size(min = 2, max = 100, message = "Imię musi mieć od 2 do 100 znaków")                                                                                                                                                                                                                                          
  String firstName,                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  @NotBlank(message = "Nazwisko jest wymagane")                                                                                                                                                                                                                                                                     
  @Size(min = 2, max = 100, message = "Nazwisko musi mieć od 2 do 100 znaków")                                                                                                                                                                                                                                      
  String lastName,                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                    
  @NotBlank(message = "Email jest wymagany")                                                                                                                                                                                                                                                                        
  @Email(message = "Nieprawidłowy format email")                                                                                                                                                                                                                                                                    
  @Size(max = 255, message = "Email nie może przekraczać 255 znaków")                                                                                                                                                                                                                                               
  String email,                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                    
  @Size(max = 20, message = "Numer telefonu nie może przekraczać 20 znaków")                                                                                                                                                                                                                                        
  String phone,                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                    
  @NotNull(message = "Kategoria jest wymagana")                                                                                                                                                                                                                                                                     
  MessageCategory category,                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                    
  @NotBlank(message = "Wiadomość jest wymagana")                                                                                                                                                                                                                                                                    
  @Size(min = 50, max = 5000, message = "Wiadomość musi mieć od 50 do 5000 znaków")                                                                                                                                                                                                                                 
  String message                                                                                                                                                                                                                                                                                                    
  ) {}                                                                                                                                                                                                                                                                                                              
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Request DTO with Bean Validation. Records are perfect for DTOs. Polish validation messages for user-facing errors.

#### File 10: Contact Form Response DTO
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/web/dto/response/ContactFormResponse.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.web.dto.response;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                    
  import pl.klastbit.lexpage.application.contact.result.ContactFormResult;                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Response DTO for successful contact form submission.                                                                                                                                                                                                                                                            
  */                                                                                                                                                                                                                                                                                                                
  public record ContactFormResponse(                                                                                                                                                                                                                                                                                
  Long messageId,                                                                                                                                                                                                                                                                                                   
  String fullName,                                                                                                                                                                                                                                                                                                  
  String email,                                                                                                                                                                                                                                                                                                     
  String message                                                                                                                                                                                                                                                                                                    
  ) {                                                                                                                                                                                                                                                                                                               
  public static ContactFormResponse fromResult(ContactFormResult result) {                                                                                                                                                                                                                                          
  return new ContactFormResponse(                                                                                                                                                                                                                                                                                   
  result.messageId(),                                                                                                                                                                                                                                                                                               
  result.fullName(),                                                                                                                                                                                                                                                                                                
  result.email(),                                                                                                                                                                                                                                                                                                   
  result.message()                                                                                                                                                                                                                                                                                                  
  );                                                                                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Clean response DTO with factory method from application result.

#### File 11: Error Response DTO
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/web/dto/response/ErrorResponse.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.web.dto.response;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                    
  import java.time.LocalDateTime;                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Standard error response DTO.                                                                                                                                                                                                                                                                                    
  */                                                                                                                                                                                                                                                                                                                
  public record ErrorResponse(                                                                                                                                                                                                                                                                                      
  String message,                                                                                                                                                                                                                                                                                                   
  String errorCode,                                                                                                                                                                                                                                                                                                 
  LocalDateTime timestamp                                                                                                                                                                                                                                                                                           
  ) {                                                                                                                                                                                                                                                                                                               
  public static ErrorResponse of(String message) {                                                                                                                                                                                                                                                                  
  return new ErrorResponse(message, null, LocalDateTime.now());                                                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  public static ErrorResponse of(String message, String errorCode) {                                                                                                                                                                                                                                                
  return new ErrorResponse(message, errorCode, LocalDateTime.now());                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Standardized error format for API responses.

#### File 12: Contact Form Controller
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/web/controller/ContactFormController.java`

  ```java                                                                                                                                                                                                                                                                                                           
  package pl.klastbit.lexpage.infrastructure.web.controller;                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    
  import jakarta.servlet.http.HttpServletRequest;                                                                                                                                                                                                                                                                   
  import jakarta.validation.Valid;                                                                                                                                                                                                                                                                                  
  import lombok.RequiredArgsConstructor;                                                                                                                                                                                                                                                                            
  import lombok.extern.slf4j.Slf4j;                                                                                                                                                                                                                                                                                 
  import org.springframework.http.HttpStatus;                                                                                                                                                                                                                                                                       
  import org.springframework.http.ResponseEntity;                                                                                                                                                                                                                                                                   
  import org.springframework.web.bind.annotation.*;                                                                                                                                                                                                                                                                 
  import pl.klastbit.lexpage.application.contact.command.SubmitContactFormCommand;                                                                                                                                                                                                                                  
  import pl.klastbit.lexpage.application.contact.result.ContactFormResult;                                                                                                                                                                                                                                          
  import pl.klastbit.lexpage.application.contact.service.ContactFormApplicationService;                                                                                                                                                                                                                             
  import pl.klastbit.lexpage.domain.contact.exception.RateLimitExceededException;                                                                                                                                                                                                                                   
  import pl.klastbit.lexpage.infrastructure.web.dto.request.SubmitContactFormRequest;                                                                                                                                                                                                                               
  import pl.klastbit.lexpage.infrastructure.web.dto.response.ContactFormResponse;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * REST controller for contact form endpoints.                                                                                                                                                                                                                                                                     
  * Inbound adapter in hexagonal architecture.                                                                                                                                                                                                                                                                      
  */                                                                                                                                                                                                                                                                                                                
  @RestController                                                                                                                                                                                                                                                                                                   
  @RequestMapping("/api/contact")                                                                                                                                                                                                                                                                                   
  @RequiredArgsConstructor                                                                                                                                                                                                                                                                                          
  @Slf4j                                                                                                                                                                                                                                                                                                            
  public class ContactFormController {                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  private final ContactFormApplicationService contactFormService;                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                    
  @PostMapping                                                                                                                                                                                                                                                                                                      
  public ResponseEntity<?> submitContactForm(                                                                                                                                                                                                                                                                       
  @Valid @RequestBody SubmitContactFormRequest request,                                                                                                                                                                                                                                                             
  HttpServletRequest httpRequest                                                                                                                                                                                                                                                                                    
  ) {
      log.info("Received contact form submission from IP: {}", getClientIp(httpRequest));

      SubmitContactFormCommand command = new SubmitContactFormCommand(
              request.firstName(),
              request.lastName(),
              request.email(),
              request.phone(),
              request.category(),
              request.message(),
              getClientIp(httpRequest),
              getUserAgent(httpRequest)
      );

      ContactFormResult result = contactFormService.submitContactForm(command);

      return ResponseEntity.ok(ContactFormResponse.fromResult(result));
  }
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Extracts client IP address from request, handling proxy headers.                                                                                                                                                                                                                                                
  */                                                                                                                                                                                                                                                                                                                
  private String getClientIp(HttpServletRequest request) {                                                                                                                                                                                                                                                          
  String ip = request.getHeader("X-Forwarded-For");                                                                                                                                                                                                                                                                 
  if (ip == null || ip.isEmpty()) {                                                                                                                                                                                                                                                                                 
  ip = request.getHeader("X-Real-IP");                                                                                                                                                                                                                                                                              
  }                                                                                                                                                                                                                                                                                                                 
  if (ip == null || ip.isEmpty()) {                                                                                                                                                                                                                                                                                 
  ip = request.getRemoteAddr();                                                                                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                                                                                 
  // Handle multiple IPs in X-Forwarded-For (take first one)                                                                                                                                                                                                                                                        
  if (ip != null && ip.contains(",")) {                                                                                                                                                                                                                                                                             
  ip = ip.split(",")[0].trim();                                                                                                                                                                                                                                                                                     
  }                                                                                                                                                                                                                                                                                                                 
  return ip;                                                                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  /**                                                                                                                                                                                                                                                                                                               
  * Extracts user agent from request.                                                                                                                                                                                                                                                                               
  */                                                                                                                                                                                                                                                                                                                
  private String getUserAgent(HttpServletRequest request) {                                                                                                                                                                                                                                                         
  return request.getHeader("User-Agent");                                                                                                                                                                                                                                                                           
  }                                                                                                                                                                                                                                                                                                                 
  }                                                                                                                                                                                                                                                                                                                 
  ```                                                                                                                                                                                                                                                                                                               

**Why**: REST controller with proper error handling. Extracts IP and user agent for tracking. Handles rate limiting gracefully.
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

### Phase 5: Minor Adjustments

#### File 13: Remove @Component from ContactMessageMapper
**Path**: `src/main/java/pl/klastbit/lexpage/infrastructure/adapters/persistence/mapper/ContactMessageMapper.java`

**Action**: Remove `@Component` annotation from line 4 since we're registering it as @Bean in MapperConfiguration.

**Before**:
  ```java                                                                                                                                                                                                                                                                                                           
  @Slf4j                                                                                                                                                                                                                                                                                                            
  @Component  // ← Remove this line                                                                                                                                                                                                                                                                                 
  public class ContactMessageMapper {                                                                                                                                                                                                                                                                               
  ```                                                                                                                                                                                                                                                                                                               

**After**:
  ```java                                                                                                                                                                                                                                                                                                           
  @Slf4j                                                                                                                                                                                                                                                                                                            
  public class ContactMessageMapper {                                                                                                                                                                                                                                                                               
  ```                                                                                                                                                                                                                                                                                                               

**Why**: Avoid duplicate bean registration (once via @Component, once via @Bean).
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

## File Summary

### Files to CREATE (12 new files):

**Domain Layer (2 files):**
1. `domain/contact/ContactRepository.java` - Repository port interface
2. `domain/contact/exception/RateLimitExceededException.java` - Domain exception

**Application Layer (3 files):**
3. `application/contact/command/SubmitContactFormCommand.java` - Command record
4. `application/contact/result/ContactFormResult.java` - Result record
5. `application/contact/service/ContactFormApplicationService.java` - Use case orchestrator

**Infrastructure - Persistence (3 files):**
6. `infrastructure/adapters/persistence/repository/JpaContactMessageRepository.java` - Spring Data interface
7. `infrastructure/adapters/persistence/repository/ContactRepositoryAdapter.java` - Repository adapter
8. `infrastructure/config/MapperConfiguration.java` - Mapper bean config

**Infrastructure - Web (4 files):**
9. `infrastructure/web/dto/request/SubmitContactFormRequest.java` - Request DTO
10. `infrastructure/web/dto/response/ContactFormResponse.java` - Response DTO
11. `infrastructure/web/dto/response/ErrorResponse.java` - Error DTO
12. `infrastructure/web/controller/ContactFormController.java` - REST controller

### Files to MODIFY (1 file):
13. `infrastructure/adapters/persistence/mapper/ContactMessageMapper.java` - Remove @Component annotation (line 4)

  ---                                                                                                                                                                                                                                                                                                               

## Testing & Verification

### Manual Testing with cURL:

  ```bash                                                                                                                                                                                                                                                                                                           
  # Test successful submission                                                                                                                                                                                                                                                                                      
  curl -X POST http://localhost:8080/api/contact \                                                                                                                                                                                                                                                                  
  -H "Content-Type: application/json" \                                                                                                                                                                                                                                                                             
  -d '{                                                                                                                                                                                                                                                                                                             
  "firstName": "Jan",                                                                                                                                                                                                                                                                                               
  "lastName": "Kowalski",                                                                                                                                                                                                                                                                                           
  "email": "jan.kowalski@example.com",                                                                                                                                                                                                                                                                              
  "phone": "+48123456789",                                                                                                                                                                                                                                                                                          
  "category": "CIVIL_LAW",                                                                                                                                                                                                                                                                                          
  "message": "To jest testowa wiadomość, która musi mieć co najmniej 50 znaków, aby przejść walidację długości."                                                                                                                                                                                                    
  }'                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  # Expected response:                                                                                                                                                                                                                                                                                              
  # {                                                                                                                                                                                                                                                                                                               
  #   "messageId": 1,                                                                                                                                                                                                                                                                                               
  #   "fullName": "Jan Kowalski",                                                                                                                                                                                                                                                                                   
  #   "email": "jan.kowalski@example.com",                                                                                                                                                                                                                                                                          
  #   "message": "Dziękujemy! Odpowiemy w ciągu 24h."                                                                                                                                                                                                                                                               
  # }                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                    
  # Test validation error (message too short)                                                                                                                                                                                                                                                                       
  curl -X POST http://localhost:8080/api/contact \                                                                                                                                                                                                                                                                  
  -H "Content-Type: application/json" \                                                                                                                                                                                                                                                                             
  -d '{                                                                                                                                                                                                                                                                                                             
  "firstName": "Jan",                                                                                                                                                                                                                                                                                               
  "lastName": "Kowalski",                                                                                                                                                                                                                                                                                           
  "email": "jan.kowalski@example.com",                                                                                                                                                                                                                                                                              
  "category": "CIVIL_LAW",                                                                                                                                                                                                                                                                                          
  "message": "Za krótka wiadomość"                                                                                                                                                                                                                                                                                  
  }'                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                    
  # Expected response: 400 Bad Request                                                                                                                                                                                                                                                                              
  # {                                                                                                                                                                                                                                                                                                               
  #   "message": "Wiadomość musi mieć od 50 do 5000 znaków",                                                                                                                                                                                                                                                        
  #   "errorCode": "VALIDATION_ERROR",                                                                                                                                                                                                                                                                              
  #   "timestamp": "2026-01-22T..."                                                                                                                                                                                                                                                                                 
  # }                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                    
  # Test rate limiting (send 4 requests quickly from same IP)                                                                                                                                                                                                                                                       
  for i in {1..4}; do                                                                                                                                                                                                                                                                                               
  curl -X POST http://localhost:8080/api/contact \                                                                                                                                                                                                                                                                  
  -H "Content-Type: application/json" \                                                                                                                                                                                                                                                                             
  -d '{                                                                                                                                                                                                                                                                                                             
  "firstName": "Jan",                                                                                                                                                                                                                                                                                               
  "lastName": "Kowalski",                                                                                                                                                                                                                                                                                           
  "email": "jan.kowalski@example.com",                                                                                                                                                                                                                                                                              
  "category": "CIVIL_LAW",                                                                                                                                                                                                                                                                                          
  "message": "Test rate limiting - wiadomość numer '$i' musi mieć co najmniej 50 znaków."                                                                                                                                                                                                                           
  }'                                                                                                                                                                                                                                                                                                                
  echo ""                                                                                                                                                                                                                                                                                                           
  done                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                    
  # Expected: First 3 succeed (200 OK), 4th fails with 429 Too Many Requests                                                                                                                                                                                                                                        
  ```                                                                                                                                                                                                                                                                                                               

### Database Verification:

  ```sql                                                                                                                                                                                                                                                                                                            
  -- Check saved messages                                                                                                                                                                                                                                                                                           
  SELECT id, first_name, last_name, email, category, status,                                                                                                                                                                                                                                                        
  recaptcha_score, ip_address, created_at                                                                                                                                                                                                                                                                           
  FROM contact_messages                                                                                                                                                                                                                                                                                             
  ORDER BY created_at DESC;                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                    
  -- Check rate limiting                                                                                                                                                                                                                                                                                            
  SELECT ip_address, COUNT(*) as message_count,                                                                                                                                                                                                                                                                     
  MAX(created_at) as last_message                                                                                                                                                                                                                                                                                   
  FROM contact_messages                                                                                                                                                                                                                                                                                             
  WHERE created_at > NOW() - INTERVAL '1 hour'                                                                                                                                                                                                                                                                      
  GROUP BY ip_address;                                                                                                                                                                                                                                                                                              
  ```                                                                                                                                                                                                                                                                                                               

### Application Startup:

  ```bash                                                                                                                                                                                                                                                                                                           
  # Start the application                                                                                                                                                                                                                                                                                           
  ./gradlew bootRun                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                    
  # Check logs for successful startup                                                                                                                                                                                                                                                                               
  # Look for:                                                                                                                                                                                                                                                                                                       
  # - Spring context initialized                                                                                                                                                                                                                                                                                    
  # - Database connection successful                                                                                                                                                                                                                                                                                
  # - ContactFormApplicationService bean created                                                                                                                                                                                                                                                                    
  # - ContactFormController mapped to /api/contact                                                                                                                                                                                                                                                                  
  ```                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                    
---                                                                                                                                                                                                                                                                                                               

## Architecture Compliance

✅ **Hexagonal Architecture**:
- Domain layer has no framework dependencies (only Lombok)
- Ports (interfaces) in domain/application layers
- Adapters (implementations) in infrastructure layer
- Clear inbound (controller) and outbound (repository) adapters

✅ **Domain-Driven Design**:
- Rich domain model (ContactMessage with business logic)
- Factory methods (create, ofExisting)
- Domain exceptions (RateLimitExceededException)
- Aggregate root pattern
- Ubiquitous language

✅ **Dependency Inversion**:
- Infrastructure depends on domain, not vice versa
- Repository interface in domain, implementation in infrastructure
- Application service depends on port interfaces

✅ **Clean Code**:
- Java Records for immutable commands/results/DTOs
- Lombok for boilerplate reduction
- Constructor injection (@RequiredArgsConstructor)
- SLF4J logging
- Meaningful method and variable names

  ---                                                                                                                                                                                                                                                                                                               

## Future Enhancements (Out of Scope for MVP)

### 1. Email Notifications
**When**: After determining email provider (Gmail, SendGrid, etc.)

**Files to add**:
- `application/contact/port/NotificationPort.java` - Outbound port interface
- `infrastructure/adapters/notification/EmailNotificationAdapter.java` - Email sender
- `infrastructure/config/AsyncConfiguration.java` - Enable @Async

**Integration point**: Add to `ContactFormApplicationService.submitContactForm()` after line 53 (after save):
  ```java                                                                                                                                                                                                                                                                                                           
  notificationPort.notifyNewContactMessage(savedMessage);                                                                                                                                                                                                                                                           
  ```                                                                                                                                                                                                                                                                                                               

### 2. reCAPTCHA v3 Integration
**When**: Ready to add spam protection

**Files to add**:
- `application/contact/port/RecaptchaVerificationPort.java` - Outbound port
- `infrastructure/adapters/recaptcha/RecaptchaVerificationAdapter.java` - Google API client
- `infrastructure/adapters/recaptcha/RecaptchaProperties.java` - Configuration
- `domain/contact/exception/InvalidRecaptchaException.java` - Domain exception

**Changes needed**:
- Add `recaptchaToken` field to `SubmitContactFormRequest`
- Add reCAPTCHA verification before domain entity creation in application service
- Replace hardcoded `new BigDecimal("0.9")` with actual score

### 3. Comprehensive Testing
**When**: Ready to add test coverage

**Test files to add**:
- `ContactMessageTest.java` - Domain entity tests
- `ContactFormApplicationServiceTest.java` - Application service tests with mocks
- `ContactRepositoryAdapterTest.java` - Integration test with TestContainers
- `ContactFormControllerTest.java` - Controller tests with MockMvc

  ---                                                                                                                                                                                                                                                                                                               

## Critical Implementation Notes

1. **Transaction Boundaries**: `ContactFormApplicationService.submitContactForm()` is annotated with `@Transactional` to ensure atomicity.

2. **Rate Limiting**: Based on IP address + 1-hour sliding window. Configurable via constants in application service.

3. **IP Extraction**: Controller handles proxy headers (X-Forwarded-For, X-Real-IP) for accurate IP tracking behind reverse proxies.

4. **Validation Layers**:
- Bean Validation on DTO (format, size)
- Command validation (null checks)
- Domain validation (business rules: 50 char minimum)

5. **Error Handling**: Controller catches domain exceptions and maps to appropriate HTTP status codes (400, 429, 500).

6. **Mapper Registration**: ContactMessageMapper registered as @Bean (not @Component) to avoid duplicate registration.

7. **Polish Messages**: User-facing validation messages and errors in Polish for better UX.

8. **Default reCAPTCHA Score**: Using `0.9` as placeholder for MVP. Will be replaced with actual verification in future iteration.

  ---                                                                                                                                                                                                                                                                                                               

## Estimated Implementation Time

- Phase 1 (Domain): 15 minutes
- Phase 2 (Application): 30 minutes
- Phase 3 (Infrastructure - Persistence): 20 minutes
- Phase 4 (Infrastructure - Web): 30 minutes
- Phase 5 (Adjustments): 5 minutes
- **Total**: ~1.5-2 hours

  ---                                                                                                                                                                                                                                                                                                               

## Success Criteria

✅ Application starts without errors                                                                                                                                                                                                                                                                              
✅ POST /api/contact endpoint responds                                                                                                                                                                                                                                                                            
✅ Valid submission returns 200 OK with message ID                                                                                                                                                                                                                                                                
✅ Invalid data returns 400 Bad Request with validation errors                                                                                                                                                                                                                                                    
✅ Rate limiting triggers after 3 requests from same IP                                                                                                                                                                                                                                                           
✅ Contact messages saved to database with correct status (NEW)                                                                                                                                                                                                                                                   
✅ IP address and user agent tracked correctly                                                                                                                                                                                                                                                                    
✅ All domain validation rules enforced (50 char minimum, email format)     